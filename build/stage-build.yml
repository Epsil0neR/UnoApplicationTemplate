parameters:
- name: applicationEnvironment
  type: string
  default: ''
- name: androidKeyStoreFile
  type: string
  default: ''
- name: androidVariableGroup
  type: string
  default: ''
- name: iosCertificateFile
  type: string
  default: ''
- name: iosProvisioningProfileFile
  type: string
  default: ''
- name: iosCertificatePassword
  type: string
  default: ''
- name: iosVariableGroup
  type: string
  default: ''
- name: additionalReleaseNotesFile
  type: string
  default: 'Canary.md'
- name: removeHyperlinksFromReleaseNotes
  type: boolean
  default: false
- name: pathToSrc
  type: string
  default: '$(Build.SourcesDirectory)/src'
- name: solutionName
  type: string
  default: '$(SolutionName)'
- name: pathToInfoPlist
  type: string
  default: '$(InfoPlistPath)'
- name: pathToAndroidManifest
  type: string
  default: '$(AndroidManifestPath)'

jobs:
  - job: On_Windows_ReleaseNotes
    pool:
      vmImage : windows-2022
    variables:
      ArtifactName: ReleaseNotes_${{ parameters.applicationEnvironment }}
      ApplicationEnvironment: ${{ parameters.applicationEnvironment }}
    steps:
      - template: steps-build-release-notes.yml
        parameters:
          additionalReleaseNotesFile: ${{ parameters.additionalReleaseNotesFile }}
          removeHyperlinksFromReleaseNotes: ${{ parameters.removeHyperlinksFromReleaseNotes }}

  - job: OnWindows_Windows
    strategy:
      matrix:
        Windows:
          ApplicationPlatform: x64
          ArtifactName: $(WindowsArtifactName)_${{ parameters.applicationEnvironment }}
          ApplicationEnvironment: ${{ parameters.applicationEnvironment }}
          BuildTargetFramework: net6.0-windows10.0.19041.0
    pool:
      vmImage : windows-2022
    steps:
      - template: steps-build-windows.yml
        parameters:
          pathToSrc: ${{ parameters.pathToSrc }}
          solutionFileName: '${{ parameters.solutionName }}.sln'
          solutionName: ${{ parameters.solutionName }}

  - job: OnWindows_Tests
    strategy:
      matrix:
        Tests:
          ArtifactName: $(TestsArtifactName)_${{ parameters.applicationEnvironment }}
          ApplicationEnvironment: ${{ parameters.applicationEnvironment }}
    pool:
      vmImage : windows-2022
    steps:
      - template: steps-build-tests.yml
        parameters:
          pathToSrc: ${{ parameters.pathToSrc }}
          solutionFileName: '${{ parameters.solutionName }}.sln'
          solutionName: ${{ parameters.solutionName }}

  - job: OnWindows_Android
    strategy:
      matrix:
        Android:
          ApplicationEnvironment: ${{ parameters.applicationEnvironment }}
          ArtifactName: $(AndroidArtifactName)_${{ parameters.applicationEnvironment }}
          ApplicationPlatform: AnyCPU
          BuildForPlayStore: False
          BuildTargetFramework: net6.0-android
          VersionCodeOffset: 1

    pool:
      vmImage : windows-2022

    variables:
    - group: ${{ parameters.androidVariableGroup }}

    steps:
    - template: steps-build-android.yml
      parameters:
        pathToSrc: ${{ parameters.pathToSrc }}
        solutionName: ${{ parameters.solutionName }}
        pathToAndroidManifest: ${{ parameters.pathToAndroidManifest }}
        androidKeyStoreFile: ${{ parameters.androidKeyStoreFile }}

  - job: OnMac_iOS
    strategy:
      matrix:
        iOS:
          ApplicationEnvironment: ${{ parameters.applicationEnvironment }}
          BuildTargetFramework: net6.0-ios
          ArtifactName: $(iOSArtifactName)_${{ parameters.applicationEnvironment }}

    pool:
      vmImage: macos-12
    
    variables:
    - name: SkipUnknownFrameworks
      value: true # Used by TargetFrameworks.Filtering package
    - group: ${{ parameters.iosVariableGroup }}

    steps:
    - template: steps-build-ios.yml
      parameters:
        pathToSrc: ${{ parameters.pathToSrc }}
        solutionName: ${{ parameters.solutionName }}
        pathToInfoPlist: ${{ parameters.pathToInfoPlist }}
        iosCertificateFile: ${{ parameters.iosCertificateFile }}
        iosCertificatePassword: ${{ parameters.iosCertificatePassword }}
        iosProvisioningProfileFile: ${{ parameters.iosProvisioningProfileFile }}